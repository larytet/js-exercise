<!DOCTYPE HTML>
<html><body>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>SSO</title>
</head>

<script>
var ports = [12381, 12382, 12383];
</script>

<script language="javascript" type="text/javascript">

function redirect(href) {
  console.log("Redirect "+href);
  document.location.href = href;
}

function getOrigURLParamValue() 
{
	var orig_url_param = 'orig_url=';
	var decodedUrlParameters = decodeURIComponent(location.search);
	var decodedOrigParam = (new RegExp(orig_url_param + '.*').exec(decodedUrlParameters)||[,""])[0].replace(orig_url_param, '').replace(/\+/g, '%20')||null;
	var encodedOrigParam = encodeURIComponent(decodedOrigParam);
	return encodedOrigParam;
}

function redirectLegacy()
{
  function empty(str)  {	
  	return !str || !/[^\s]+/.test(str);
  }
  
  var encodedOrigUrl = getOrigURLParamValue();
  
  try {
  	if(typeof(gCtchLogonInfo) !== 'undefined') {	    	
  		var modified_redirect_url = "https://" + window.location.hostname +'/EUP/transparent_login/?orig_url=' + encodedOrigUrl + '&winUserId=' +gCtchLogonInfo.winUserId ;
  		if (!empty(gCtchLogonInfo.orgName)) {
  			modified_redirect_url = modified_redirect_url.concat("&orgName=",gCtchLogonInfo.orgName);
  		}
  		if (!empty(gCtchLogonInfo.userName)) {
  			modified_redirect_url = modified_redirect_url.concat("&userName=",gCtchLogonInfo.userName);
  		}
  		redirect(modified_redirect_url);
  	}
  	else {
  		redirect("https://" + window.location.hostname + '/EUP/login?orig_url=' + encodedOrigUrl);
  	}
  }
  catch(e) {
  	redirect("https://" + window.location.hostname + '/EUP/login?orig_url='+ encodedOrigUrl);
  }
}

class XMLHttpAsyncRequest {
  constructor(url, timeout) {
    var xhr = new XMLHttpRequest();
  	xhr.open('GET', url, true);
    xhr._requestUrl = url;
    xhr._result = XMLHttpAsyncRequest.Result.unknown;
    xhr.timeout = timeout;
  	xhr.onload = this.onload
  	xhr.ontimeout = this.ontimeout
  	xhr.onerror = this.onerror
  	this._xhr = xhr;
    this._timestampStarted = new Date().getTime();
    xhr.send(null);
    console.log("Send GET: "+url);
  }
  static get Result() {
    return {"unknown": 0, "error": 1, "timeout": 2, "ok": 3};
  }
  getUrl() {
    return this._xhr._requestUrl;
  }
  isError() {
    return (this._xhr._result == XMLHttpAsyncRequest.Result.error);
  }
  onload() {
    this._timestampCompleted = new Date().getTime();
    this._result = XMLHttpAsyncRequest.Result.ok;
    console.log("Onload: "+this.response);
  }
  ontimeout(e) {
    this._timestampCompleted = new Date().getTime();
    this._result = XMLHttpAsyncRequest.Result.timeout;
    console.log("Ontimeout: status="+this.statusText+" total="+e.total+" lengthComputable="+e.lengthComputable);
  }
  onerror(e) {
    this._timestampCompleted = new Date().getTime();
    this._result = XMLHttpAsyncRequest.Result.error;
    console.log("Onerror: url=" + this._requestUrl);
  }
}

class JsScriptLoader {
  constructor (url, onload) {
    var elementScript = document.createElement('script');
    elementScript._requestUrl = url
    elementScript.onload = onload;
    elementScript.onerror = function (e) {
      console.log("Onerror: url=" + this._requestUrl);
    }
    elementScript.src = url
    document.head.appendChild(elementScript);
  }
}

function createLocalUrl(port) {
  return "https://127.0.0.1:"+port+"/index.html"
}

function createRemoteUrl(ports) {
  hostname = window.location.hostname
  var url = "https://" + hostname;
  ports.forEach(function(port) {
    url += port.toString() + "."
  });
  url = url.substring(0, url.length - 1);
  return url;
}

// New style SSO involves knocking the local HTTP server
var requestTimeout = 500;
requests = []
ports.forEach(function(port) {
  var url = createLocalUrl(port)
  requests.push(new XMLHttpAsyncRequest(url, requestTimeout));
});

// I have to support backward compatibility 
// Try the legacy way of SSO
new JsScriptLoader("http://127.0.0.1:12381/auth", function () {
    console.log("Got the legacy script from " + legacyWinIdScriptUrl);
    // I expect a JS which contains gCtchLogonInfo = {"winUserId": id, "orgName": orgName, "userName": userName}
    redirectLegacy();
  });
  
// New style SSO - get the data from the server
new JsScriptLoader(createRemoteUrl(ports), function () {
    console.log("Got the script from " + winIdScriptUrl);
    // I expect a JS which contains gCtchLogonInfo = {"winUserId": id, "orgName": orgName, "userName": userName}
    redirectLegacy();
  });

function printStatus()
{
  requests.forEach(function(request) {
    var xhr = request._xhr
    var requestTime = xhr._timestampCompleted - request._timestampStarted
    url = request.getUrl();
    if (request.isError()) {
      if (requestTime < 40 ){
        var resultStr = "succeeded" 
      }
      else {
        var resultStr = "failed" 
      }
      console.log("Knock " + url + " is probably " + resultStr + " , time " + requestTime.toString() + "ms");
    }
  });
}

setTimeout(printStatus, requestTimeout+500)

</script>

</body></html>
