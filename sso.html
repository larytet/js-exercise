<!DOCTYPE HTML>
<html><body>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>SSO</title>
</head>

<script language="javascript" type="text/javascript">

/// The JS implements two different SSO flows: legacy and the new flow  
/// Legacy SSO:
///   - Load a JS from http://127.0.0.1:12381/auth
///   - Use global variable gCtchLogonInfo to build the login URL
///
/// New SSO:
///   - "Knock" the ports specified by the portsToKnock array
///   - Knocks shall timeout 
///   - Get the JS with gCtchLogonInfo from the server

</script>

<script>
var portsToKnock = [12381, 12382, 12383, 12384];
</script>

<script language="javascript" type="text/javascript">

function redirect(href) {
  console.log("Redirect "+href);
  document.location.href = href;
}

function getOrigURLParamValue() 
{
	var orig_url_param = 'orig_url=';
	var decodedUrlParameters = decodeURIComponent(location.search);
	var decodedOrigParam = (new RegExp(orig_url_param + '.*').exec(decodedUrlParameters)||[,""])[0].replace(orig_url_param, '').replace(/\+/g, '%20')||null;
	var encodedOrigParam = encodeURIComponent(decodedOrigParam);
	return encodedOrigParam;
}

function redirectLegacy()
{
  function empty(str)  {	
  	return !str || !/[^\s]+/.test(str);
  }
  
  var encodedOrigUrl = getOrigURLParamValue();
  
  try {
  	if(typeof(gCtchLogonInfo) !== 'undefined') {	    	
  		var modified_redirect_url = "https://" + window.location.hostname +'/EUP/transparent_login/?orig_url=' + encodedOrigUrl + '&winUserId=' +gCtchLogonInfo.winUserId ;
  		if (!empty(gCtchLogonInfo.orgName)) {
  			modified_redirect_url = modified_redirect_url.concat("&orgName=",gCtchLogonInfo.orgName);
  		}
  		if (!empty(gCtchLogonInfo.userName)) {
  			modified_redirect_url = modified_redirect_url.concat("&userName=",gCtchLogonInfo.userName);
  		}
  		redirect(modified_redirect_url);
  	}
  	else {
  		redirect("https://" + window.location.hostname + '/EUP/login?orig_url=' + encodedOrigUrl);
  	}
  }
  catch(e) {
  	redirect("https://" + window.location.hostname + '/EUP/login?orig_url='+ encodedOrigUrl);
  }
}

class JsScriptLoader {
  static get Result() {
    return {"unknown": 0, "error": 1, "timeout": 2, "ok": 3};
  }
  getUrl() {
    return this._xhr._requestUrl;
  }
  isTimeout() {
    return (this._xhr._result == JsScriptLoader.Result.timeout); 
  }
  isUnknown() {
    return (this._xhr._result == JsScriptLoader.Result.unknown); 
  }
  getTime() {
    return (this._xhr._timestampCompleted - this._timestampStarted);
  }
  constructor (url, onload=null) {
    var elementScript = document.createElement('script');
    elementScript._requestUrl = url
    this._xhr = elementScript
    this._xhr._result = JsScriptLoader.Result.unknown;
    if (onload != null) {
      elementScript.onload = onload;
    }
    elementScript.onerror = function (e) {
      this._timestampCompleted = new Date().getTime();
      this._result = JsScriptLoader.Result.error;
      console.log("Onerror: url=" + this._requestUrl);
    }
    elementScript.ontimeout = function (e) {
      this._timestampCompleted = new Date().getTime();
      this._result = JsScriptLoader.Result.timeout;
      console.log("Ontimeout: url=" + this._requestUrl);
    }
    elementScript.src = url
    this._timestampStarted = new Date().getTime();
    document.head.appendChild(elementScript);
  }
}

function createLocalUrl(port) {
  return "https://127.0.0.1:"+port+"/index.html"
}

function createRemoteUrl(ports) {
  hostname = window.location.hostname
  var url = "https://" + hostname;
  ports.forEach(function(port) {
    url += port.toString() + "."
  });
  url = url.substring(0, url.length - 1);
  return url;
}

// New style SSO involves knocking the local HTTP server
requests = []
portsToKnock.forEach(function(port) {
  var url = createLocalUrl(port)
  requests.push(new JsScriptLoader(url));
});

// I have to support backward compatibility 
// Try the legacy way of SSO
new JsScriptLoader("http://127.0.0.1:12381/auth", function () {
    console.log("Got the legacy script from " + legacyWinIdScriptUrl);
    // I expect a JS which contains gCtchLogonInfo = {"winUserId": id, "orgName": orgName, "userName": userName}
    redirectLegacy();
  });
  
// New style SSO - get the data from the server
new JsScriptLoader(createRemoteUrl(portsToKnock), function () {
    console.log("Got the script from " + winIdScriptUrl);
    // I expect a JS which contains gCtchLogonInfo = {"winUserId": id, "orgName": orgName, "userName": userName}
    redirectLegacy();
  });

var knocksPollingPeriod = 50; //ms
var knocksPollingTimeout = 10*1000; //ms

function waitForKnocks(count)
{
  var knocksCompleted = true;
  var expired = count >= knocksPollingTimeout/knocksPollingPeriod;

  requests.forEach(function(request) {
    url = request.getUrl();
    var requestTime = request.getTime()
    if (request.isUnknown()) {
      knocksCompleted = false; 
    }
  });

  if (knocksCompleted) {
    console.log("Knocks probably succeeded, time " + (count*knocksPollingPeriod).toString() + "ms");
    return
  }
  if (!expired) {
    setTimeout(waitForKnocks, knocksPollingPeriod, count+1)
  }
  else {
    console.log("Knocks failed, time " + (count*knocksPollingPeriod).toString() + "ms");
  }
}

setTimeout(waitForKnocks, knocksPollingPeriod, 0) 

</script>

</body></html>
